name: Dependabot Notifications

# This workflow sends Slack notifications when CI completes for Dependabot PRs.
# It uses workflow_run to trigger AFTER the CI workflow finishes.


on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: read
  actions: read

jobs:
  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.actor.login == 'dependabot[bot]'

    steps:
      - name: Get PR information
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });
            
            if (pullRequests.length > 0) {
              const pr = pullRequests[0];
              core.setOutput('pr_number', pr.number);
              core.setOutput('pr_title', pr.title);
              core.setOutput('pr_url', pr.html_url);
              core.setOutput('found', 'true');
            } else {
              core.setOutput('found', 'false');
            }

      - name: Send Slack notification (Success)
        if: steps.pr-info.outputs.found == 'true'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: "#36a64f"
          SLACK_USERNAME: "Dependabot"
          SLACK_ICON: "https://avatars.githubusercontent.com/in/29110?s=64&v=4"
          SLACK_TITLE: "âœ… Dependabot Update - CI Passed"
          SLACK_MESSAGE: |
            *Repository:* ${{ github.repository }}
            *PR:* <${{ steps.pr-info.outputs.pr_url }}|#${{ steps.pr-info.outputs.pr_number }}> ${{ steps.pr-info.outputs.pr_title }}
            *Status:* All CI checks passed! Auto-merge has been enabled.
            
            The PR will be automatically merged once all branch protection requirements are satisfied.
          SLACK_FOOTER: "logzio-python-handler CI"


  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.actor.login == 'dependabot[bot]'

    steps:
      - name: Get PR information
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });
            
            if (pullRequests.length > 0) {
              const pr = pullRequests[0];
              core.setOutput('pr_number', pr.number);
              core.setOutput('pr_title', pr.title);
              core.setOutput('pr_url', pr.html_url);
              core.setOutput('found', 'true');
            } else {
              core.setOutput('found', 'false');
            }

      - name: Get workflow run URL
        id: run-url
        run: |
          echo "url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT

      - name: Send Slack notification (Failure)
        if: steps.pr-info.outputs.found == 'true'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: "#ff0000"
          SLACK_USERNAME: "Dependabot"
          SLACK_ICON: "https://avatars.githubusercontent.com/in/29110?s=64&v=4"
          SLACK_TITLE: "ðŸš¨ Dependabot Update - CI Failed"
          SLACK_MESSAGE: |
            *Repository:* ${{ github.repository }}
            *PR:* <${{ steps.pr-info.outputs.pr_url }}|#${{ steps.pr-info.outputs.pr_number }}> ${{ steps.pr-info.outputs.pr_title }}
            *Status:* CI checks failed - manual intervention required!
            
            <${{ steps.run-url.outputs.url }}|View CI Run> to investigate the failure.
          SLACK_FOOTER: "logzio-python-handler CI"

  notify-merged:
    name: Notify Merged
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      contains(github.event.workflow_run.head_commit.message, 'dependabot')

    steps:
      - name: Send Slack notification (Merged)
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: "#2eb886"
          SLACK_USERNAME: "Dependabot"
          SLACK_ICON: "https://avatars.githubusercontent.com/in/29110?s=64&v=4"
          SLACK_TITLE: "ðŸŽ‰ Dependencies Updated Successfully"
          SLACK_MESSAGE: |
            *Repository:* ${{ github.repository }}
            *Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.event.workflow_run.head_sha }}|${{ github.event.workflow_run.head_sha }}>
            
            Dependabot updates have been merged and CI passed on main branch.
          SLACK_FOOTER: "logzio-python-handler CI"

